---
import BaseLayout from '../../layouts/BaseLayout.astro';
import cars from '../../data/car_data.json';
import { getSupportTypeColor } from '../../utils/supportType';
import InfoCard from '../../components/InfoCard';

// Generate all possible car paths at build time
export async function getStaticPaths() {
	return cars.map(car => ({
		params: { car: `${car.make}-${car.model}`.toLowerCase() },
		props: { carData: car },
	}));
}

const { carData } = Astro.props;
---

<BaseLayout title={`${carData.make} ${carData.model} - opendbc`}>
	<main class="min-h-screen bg-[#E8E8E8]">
		<div class="max-w-7xl mx-auto pl-5">
				<!-- Breadcrumb -->
				<nav class="flex items-center space-x-2 text-md pb-4">
						<a href="/" class="hover:underline">Home</a>
						<span>&gt;</span>
						<span>{carData.make} {carData.model} {carData.years}</span>
				</nav>
		</div>

		<div class="max-w-7xl mx-auto px-5">
			<div class="flex flex-col lg:flex-row gap-8">
				<!-- Left Sidebar -->
				<div class="lg:w-80 flex-shrink-0">
					<!-- Sidebar Header -->
					<div class="mb-6">
						<div class="bg-black text-white py-3 pl-4">
							<h1 class="text-xl font-bold">{carData.make}</h1>
						</div>
						<div class="bg-white">
							<div class="py-3 pl-4">
								<p class="font-medium">{carData.years} {carData.make} {carData.model}</p>
							</div>
						</div>
					</div>

					<!-- Key Specs -->
					<InfoCard label="Key Specs" client:load>
						<div class="divide-y divide-gray-200">
							<div class="p-4">
								<p class="text-sm"><strong>Support Type:</strong></p>
								<div class={`text-l mt-1 px-4 py-2 inline-block ${getSupportTypeColor(carData.support_type)}`}>
									{carData.support_type}
								</div>
							</div>
							<div class="p-4">
								<p class="text-sm"><strong>ADAS Package:</strong></p>
								<p class="text-l mt-1">{carData.package}</p>
							</div>
							<div class="p-4">
								<p class="text-sm"><strong>Fingerprint:</strong></p>
								<p class="text-l mt-1">{carData.car_fingerprint}</p>
							</div>
							{carData.harness && (
								<div class="p-4">
									<p class="text-sm"><strong>Harness:</strong></p>
									<p class="text-l mt-1">{carData.harness}</p>
								</div>
							)}
							<div class="p-4">
								<p class="text-sm"><strong>Longitudinal Report:</strong></p>
								<p class="text-l mt-1">
									<a href="https://commaai.github.io/opendbc-data/longitudinal_reports/FORD_BRONCO_SPORT_MK1_b9d015f8ff659e1e_0000043a--98baf2b862.html" 
									   class="text-blue-600 hover:text-blue-800 hover:underline" 
									   target="_blank">
										View Report
									</a>
								</p>
							</div>
						</div>
					</InfoCard>
				</div>

				<!-- Main Content -->
				<div class="flex-1">
					<div class="flex flex-col lg:flex-row lg:gap-4">
						<!-- General Information -->
						<div class="lg:w-2/3">
							<InfoCard label="General Information" client:load>
								<div class="p-6">
									<div set:html={carData.detail_sentence} class="prose max-w-none" />
									{carData.footnotes.length > 0 && (
										<ul class="mt-4 list-disc list-inside space-y-2">
											{carData.footnotes.map(note => (
												<li class="text-sm text-gray-600">{note}</li>
											))}
										</ul>
									)}
								</div>
							</InfoCard>
						</div>

						<!-- Metrics Section -->
						<div class="lg:w-1/3">
							<InfoCard label="Vehicle Metrics" client:load>
								<div class="divide-y divide-gray-200">
									<div class="flex justify-between items-center px-4 py-3 bg-gray-50">
										<span class="text-sm font-medium">Mass</span>
										<span class="text-sm">{Math.round(carData.mass)} kg</span>
									</div>
									<div class="flex justify-between items-center px-4 py-3">
										<span class="text-sm font-medium">Wheelbase</span>
										<span class="text-sm">{carData.wheelbase} m</span>
									</div>
									<div class="flex justify-between items-center px-4 py-3 bg-gray-50">
										<span class="text-sm font-medium">Steer Ratio</span>
										<span class="text-sm">{carData.steer_ratio}</span>
									</div>
									<div class="flex justify-between items-center px-4 py-3">
										<span class="text-sm font-medium">Center to Front Ratio</span>
										<span class="text-sm">{carData.center_to_front_ratio}</span>
									</div>
									<div class="flex justify-between items-center px-4 py-3 bg-gray-50">
										<span class="text-sm font-medium">Max Lateral Accel</span>
										<span class="text-sm">{carData.max_lateral_accel} m/s²</span>
									</div>
								</div>
							</InfoCard>
						</div>
					</div>

					<!-- Technical Parameters -->
					<InfoCard label="Technical Parameters" client:load>
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 px-5 py-8">
							<div class="border bg-white flex flex-col">
								<h3 class="text-sm font-medium px-3 py-3 uppercase">Tire Configuration:</h3>
								<div class="flex-1 flex flex-col">
									<div class="flex justify-between bg-gray-50 flex-1 items-center px-3 py-5">
										<span class="text-sm">Stiffness Factor</span>
										<span class="text-sm">{carData.tire_stiffness_factor}</span>
									</div>
									<div class="flex justify-between flex-1 items-center px-3 py-5">
										<span class="text-sm">Front Stiffness</span>
										<span class="text-sm">{Math.round(carData.tire_stiffness_front)}</span>
									</div>
									<div class="flex justify-between bg-gray-50 flex-1 items-center px-3 py-5">
										<span class="text-sm">Rear Stiffness</span>
										<span class="text-sm">{Math.round(carData.tire_stiffness_rear)}</span>
									</div>
								</div>
							</div>
							<div class="border bg-white flex flex-col">
								<h3 class="text-sm font-medium px-3 py-3 uppercase">Vehicle Control:</h3>
								<div class="flex-1 flex flex-col">
									<div class="flex justify-between bg-gray-50 flex-1 items-center px-3 py-5">
										<span class="text-sm">Actuator Delay</span>
										<span class="text-sm">{carData.steer_actuator_delay}s</span>
									</div>
									<div class="flex justify-between flex-1 items-center px-3 py-5">
										<span class="text-sm">Limit Timer</span>
										<span class="text-sm">{carData.steer_limit_timer}s</span>
									</div>
									<div class="flex justify-between bg-gray-50 flex-1 items-center px-3 py-5">
										<span class="text-sm">Control Type</span>
										<span class="text-sm">{carData.steer_control_type}</span>
									</div>
								</div>
							</div>
							<div class="border bg-white flex flex-col">
								<h3 class="text-sm font-medium px-3 py-3 uppercase">Speed Parameters:</h3>
								<div class="flex-1 flex flex-col">
									<div class="flex justify-between bg-gray-50 flex-1 items-center px-3 py-5">
										<span class="text-sm">Stopping Speed</span>
										<span class="text-sm">{carData.vEgo_stopping} m/s</span>
									</div>
									<div class="flex justify-between flex-1 items-center px-3 py-5">
										<span class="text-sm">Starting Speed</span>
										<span class="text-sm">{carData.vEgo_starting} m/s</span>
									</div>
									<div class="flex justify-between bg-gray-50 flex-1 items-center px-3 py-5">
										<span class="text-sm">Stop Accel</span>
										<span class="text-sm">{carData.stop_accel} m/s²</span>
									</div>
								</div>
							</div>
						</div>
					</InfoCard>

					<!-- System Configuration -->
					<InfoCard label="System Configuration" client:load>
						<div class="p-6">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
								<div>
									<h3 class="text-sm font-medium mb-3 uppercase">Network Settings:</h3>
									<div class="space-y-3">
										<div class="flex items-center justify-between bg-gray-50 p-3">
											<span class="text-sm">Network Location</span>
											<span class="text-sm font-mono">{carData.network_location}</span>
										</div>
										<div class="flex items-center justify-between p-3 border">
											<span class="text-sm">Transmission Type</span>
											<span class="text-sm">{carData.transmissionType}</span>
										</div>
										<div class="flex items-center justify-between bg-gray-50 p-3">
											<span class="text-sm">Bus Lookup</span>
											<span class="text-sm font-mono">{JSON.stringify(carData.bus_lookup)}</span>
										</div>
									</div>
								</div>
								<div>
									<h3 class="text-sm font-medium mb-3 uppercase">Feature Flags:</h3>
									<div class="space-y-3">
										<div class="flex items-center justify-between p-3 border">
											<span class="text-sm">Experimental Longitudinal</span>
											<span class="text-sm">{carData.experimental_longitudinal_available ? "Enabled" : "Disabled"}</span>
										</div>
										<div class="flex items-center justify-between bg-gray-50 p-3">
											<span class="text-sm">DSU Enabled</span>
											<span class="text-sm">{carData.enable_dsu ? "Yes" : "No"}</span>
										</div>
										<div class="flex items-center justify-between p-3 border">
											<span class="text-sm">BSM Enabled</span>
											<span class="text-sm">{carData.enable_bsm ? "Yes" : "No"}</span>
										</div>
										<div class="flex items-center justify-between bg-gray-50 p-3">
											<span class="text-sm">PCM Cruise</span>
											<span class="text-sm">{carData.pcm_cruise ? "Yes" : "No"}</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</InfoCard>

					<!-- Required Parts -->
					{carData.car_parts.length > 0 && (
						<InfoCard label="Required Parts" client:load>
							<div class="p-6">
								<ul class="space-y-3">
									{carData.car_parts.map(part => (
										<li class="flex items-center space-x-2">
											<span class="w-2 h-2 bg-black rounded-full"></span>
											<span>{part}</span>
										</li>
									))}
								</ul>
							</div>
						</InfoCard>
					)}

					<!-- Capabilities -->
					<InfoCard label="Capabilities" client:load>
						<div class="divide-y divide-gray-200">
							<div class="flex justify-between items-center px-6 py-4 bg-gray-50">
								<span class="font-medium">Minimum Steering Speed</span>
								<span>{carData.min_steer_speed} mph</span>
							</div>
							<div class="flex justify-between items-center px-6 py-4">
								<span class="font-medium">FSR Longitudinal Control</span>
								<span>{carData.fsr_longitudinal}</span>
							</div>
							<div class="flex justify-between items-center px-6 py-4 bg-gray-50">
								<span class="font-medium">FSR Steering Control</span>
								<span>{carData.fsr_steering}</span>
							</div>
							<div class="flex justify-between items-center px-6 py-4">
								<span class="font-medium">Longitudinal Control Type</span>
								<span>{carData.longitudinal}</span>
							</div>
							<div class="flex justify-between items-center px-6 py-4 bg-gray-50">
								<span class="font-medium">Support Type</span>
								<span>{carData.support_type}</span>
							</div>
							<div class="flex justify-between items-center px-6 py-4">
								<span class="font-medium">Required Package</span>
								<span>{carData.package}</span>
							</div>
							<div class="flex justify-between items-center px-6 py-4 bg-gray-50">
								<span class="font-medium">Auto Resume</span>
								<span>{carData.auto_resume ? "Yes" : "No"}</span>
							</div>
							<div class="flex justify-between items-center px-6 py-4">
								<span class="font-medium">Steering Torque</span>
								<span>{carData.steering_torque}</span>
							</div>
						</div>
					</InfoCard>

					<!-- Car Notes -->
					<InfoCard label="Car Notes" client:load>
						<div class="p-6">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div class="border border-black p-4">
									<p class="text-sm font-medium">Longitudinal Control</p>
									<p class="mt-2">{carData.longitudinal}</p>
								</div>
								<div class="border border-black p-4">
									<p class="text-sm font-medium">Steering Torque</p>
									<p class="mt-2">{carData.steering_torque}</p>
								</div>
								<div class="border border-black p-4">
									<p class="text-sm font-medium">Auto Resume</p>
									<p class="mt-2">{carData.auto_resume_star}</p>
								</div>
							</div>
						</div>
					</InfoCard>

					<!-- Tutorials -->
					<InfoCard label="Tutorials" client:load>
						<div class="p-6">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div class="border border-black p-4">
									<p class="text-sm font-medium">Longitudinal Control</p>
									<p class="mt-2">{carData.longitudinal}</p>
								</div>
								<div class="border border-black p-4">
									<p class="text-sm font-medium">Steering Torque</p>
									<p class="mt-2">{carData.steering_torque}</p>
								</div>
								<div class="border border-black p-4">
									<p class="text-sm font-medium">Auto Resume</p>
									<p class="mt-2">{carData.auto_resume_star}</p>
								</div>
							</div>
						</div>
					</InfoCard>

					<!-- Demo Video -->
					{carData.video && (
						<InfoCard label="Demo Video" client:load>
							<div class="p-6">
								<div class="aspect-w-16 aspect-h-9">
									<iframe
										src={carData.video.replace('watch?v=', 'embed/')}
										title={`${carData.make} ${carData.model} Demo`}
										allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
										allowfullscreen
										class="w-full h-full border border-black"
									></iframe>
								</div>
							</div>
						</InfoCard>
					)}
				</div>
			</div>
		</div>
	</main>
</BaseLayout> 